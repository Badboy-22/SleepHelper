async function whoAmI(){const r=await fetch("/api/auth/me",{credentials:"include"});if(!r.ok)return null;const{user}=await r.json().catch(()=>({user:null}));return user||null}function fmtTime(s){if(!s)return"";return s.includes("T")?s.replace("T"," ").slice(0,16):s}async function loadLists(d){document.getElementById("title-fatigue").textContent=`${d} 피로도`;const f=await fetch(`/api/fatigue?date=${d}`).then(r=>r.json());const ulF=document.getElementById("fatigue-list");ulF.innerHTML=f.items&&f.items.length?"":"<li>기록 없음</li>";(f.items||[]).forEach(it=>{const li=document.createElement("li");const t=new Date(it.recordedAt);li.textContent=`${t.toLocaleTimeString()} · ${it.type} · ${it.value}`;ulF.appendChild(li)});const s=await fetch(`/api/schedule?date=${d}`).then(r=>r.json());const ulS=document.getElementById("schedule-list");ulS.innerHTML=s.items&&s.items.length?"":"<li>일정 없음</li>";(s.items||[]).forEach(it=>{const li=document.createElement("li");li.textContent=`${fmtTime(it.start)} ~ ${fmtTime(it.end)} · ${it.title||""}`;ulS.appendChild(li)})}document.addEventListener("DOMContentLoaded",async()=>{const me=await whoAmI();if(!me){location.href="/login.html";return}const day=document.getElementById("day");const today=new Date().toISOString().slice(0,10);day.value=today;await loadLists(day.value);day.addEventListener("change",()=>loadLists(day.value));const form=document.getElementById("fatigue-form");form.addEventListener("submit",async e=>{e.preventDefault();const fd=new FormData(form);const payload={type:fd.get("type"),value:Number(fd.get("value")),note:fd.get("note")||null,date:day.value,recordedAt:new Date().toISOString()};const r=await fetch("/api/fatigue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const data=await r.json().catch(()=>({}));document.getElementById("save-msg").textContent=r.ok?"Saved.":data.error||"error";if(r.ok){form.reset();await loadLists(day.value)}});document.getElementById("logout").addEventListener("click",async()=>{await fetch("/api/auth/logout",{method:"POST"});location.href="/login.html"})});